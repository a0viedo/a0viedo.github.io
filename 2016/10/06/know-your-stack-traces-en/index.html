<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="description"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Know Your Stack Traces</title><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/fonts/iconfont/iconfont.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,600|Roboto Mono"><!-- google analytics--><script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-36283546-3', 'auto');
ga('send', 'pageview');</script></head><body><div id="main"><header><a href="/." class="logo">Elendur</a><ul class="nav"><li class="nav-link"><a href="/" target="_self">Home</a></li><li class="nav-link"><a href="/archives/" target="_self">Archives</a></li><li class="nav-link"><a href="/tags/" target="_self">Tags</a></li><li class="nav-link"><a href="/about/" target="_self">About</a></li></ul></header><section id="container"><article class="post"><h1 class="post-title">Know Your Stack Traces</h1><span class="post-time">Oct 6, 2016</span><span style="float:right; font-style: italic">Read the post in: <a href="/2016/10/06/know-your-stack-traces-en" class="lang-link">english</a>,&nbsp;<a href="/2016/10/06/know-your-stack-traces-es" class="lang-link">spanish</a></span><div class="post-content"><p>The last couple of months I’ve been working in an application with a microservices architecture. I had to debug message errors like “Something went wrong with your request” with scarce and non-descriptive stack traces.<br>While trying to find those errors I learned a few things.</p>
<h2 id="Stack-this-stack-that"><a href="#Stack-this-stack-that" class="headerlink" title="Stack this, stack that"></a>Stack this, stack that</h2><p>The stack is the part of memory that keeps track at all times the functions invoked until a specific moment in your program. <strong>Think of a stack trace as a set of entries with an order of precedence</strong>, generally from top to bottom from most recent to older functions respectively.</p>
<p>Let’s make some nested function calls with the help of recursion and <code>eval</code>:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fn</span>(<span class="params">n</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(n === <span class="number">0</span>) <span class="keyword">return</span> <span class="built_in">Error</span>().stack;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">eval</span>(<span class="string">`(function fn<span class="subst">$&#123;n&#125;</span>()&#123; return fn(n-1)&#125;)()`</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(fn(<span class="number">10</span>));</span><br></pre></td></tr></table></figure></p>
<p>Running the previous example in Chrome (and Node.js or any V8-based runtime) will show you something like the following:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Error</span><br><span class="line">    at Error (native)</span><br><span class="line">    at fn (&lt;anonymous&gt;:2:24)</span><br><span class="line">    at fn1 (eval at fn (unknown source), &lt;anonymous&gt;:1:25)</span><br><span class="line">    at eval (eval at fn (unknown source), &lt;anonymous&gt;:1:34)</span><br><span class="line">    at fn (&lt;anonymous&gt;:3:12)</span><br><span class="line">    at fn2 (eval at fn (unknown source), &lt;anonymous&gt;:1:25)</span><br><span class="line">    at eval (eval at fn (unknown source), &lt;anonymous&gt;:1:34)</span><br><span class="line">    at fn (&lt;anonymous&gt;:3:12)</span><br><span class="line">    at fn3 (eval at fn (unknown source), &lt;anonymous&gt;:1:25)</span><br><span class="line">    at eval (eval at fn (unknown source), &lt;anonymous&gt;:1:34)</span><br></pre></td></tr></table></figure></p>
<p>It’s being chopped up, Chrome defaults to a limit of 10 stack frames. To change the limit in Chrome, Node or Edge you can run <code>Error.stackTraceLimit = Infinity</code>.</p>
<p>In Firefox, the limit is 128 stack frames (at least a power of 2, right?) and <a href="https://dxr.mozilla.org/mozilla-central/rev/ea104eeb14cc54da9a06c3766da63f73117723a0/js/src/jsexn.cpp#238" target="_blank" rel="external">it seems it’s being hardcoded</a>. In Safari it’s not limited at all. </p>
<h2 id="Long-stack-traces"><a href="#Long-stack-traces" class="headerlink" title="Long stack traces"></a>Long stack traces</h2><p>Asynchronous stack traces, also called long stack traces, are something you will have to deal with if you write JavaScript. First, if you haven’t seen Philip Roberts’s talk <a href="https://www.youtube.com/watch?v=8aGhZQkoFbQ" target="_blank" rel="external">“What the Heck is the Event Loop anyway”</a> go and watch it now, I’ll wait.</p>
<p>Done? Ok, let’s continue.</p>
<p>By the nature of how things are brought up in the event loop, any async operation (timers or I/O) will have a <em>local</em> stack trace. See <a href="https://nodejs.org/api/errors.html#errors_new_error_message" target="_blank" rel="external">Node.js documentation on errors</a>:</p>
<blockquote>
<p>Stack traces extend only to either (a) the beginning of synchronous code execution, or (b) the number of frames given by the property Error.stackTraceLimit, whichever is smaller.</p>
</blockquote>
<p>When debugging it’s common to want as much granularity as you can get to be able to identify the path to the line of code that has the error. No matter if it went through async operations to get executed. </p>
<p>That’s when long stack traces comes in: they are an extension of stack traces in an attempt of tracing the original source of async operations.</p>
<p><a href="https://www.npmjs.com/package/longjohn" target="_blank" rel="external">Longjohn</a> is a useful npm package that will trace every asynchronous operation and will provide you with a complete stack trace (internally it monkeypatches every async operation with their own wrapper to do so).</p>
<p>Here’s how you can get long stack traces with Longjohn and Bluebird (just happens to be the one I use, could be any promises implementation):<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'longjohn'</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="built_in">Promise</span> = <span class="built_in">require</span>(<span class="string">'bluebird'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">example</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="built_in">Promise</span>.resolve().then(() =&gt; <span class="built_in">console</span>.log(<span class="built_in">Error</span>().stack));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">example();</span><br></pre></td></tr></table></figure></p>
<p>Be aware that using long stack traces will have some performance overhead.</p>
<p>Note for Bluebird users: the <a href="http://bluebirdjs.com/docs/api/promise.longstacktraces.html" target="_blank" rel="external">long stack traces feature</a> will work only when throwing. Example:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="built_in">Promise</span> = <span class="built_in">require</span>(<span class="string">'bluebird'</span>);</span><br><span class="line"><span class="built_in">Promise</span>.longStackTraces();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">example</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="built_in">Promise</span>.resolve().then(() =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">Error</span>().stack); <span class="comment">// no appereance of the function name</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">example();</span><br></pre></td></tr></table></figure></p>
<p>Which is not good for tracing tools that use the state of the stack but do not throw.</p>
<h2 id="What’s-next"><a href="#What’s-next" class="headerlink" title="What’s next?"></a>What’s next?</h2><p>It’s a (not well-known)problem the fact that we can’t get native promises (Node v4 or later) with asynchronous stack traces working. If you get an <code>unhandledRejection</code> error in your application and you’re using native promises, <strong>the only workaround to get an async stack trace is switching to another Promises implementation and use a package like <a href="https://www.npmjs.com/package/longjohn" target="_blank" rel="external">longjohn</a>.</strong></p>
<p>And for now, it’s not clear how the problem of asynchronous stack traces with native promises it’s going to be solved, either for Node.js or in browsers. <a href="https://github.com/nodejs/node-eps/pull/18" target="_blank" rel="external">AsyncHooks</a> sounds like a plausible solution for Node. I only know that I’ll be avoiding using native promises for some time.</p>
<p>Are you using other tools? Have you encountered other problems? Let me know in the comments.</p>
</div></article><ul class="share-buttons">
  <li><a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Felendur.com&t=" title="Share on Facebook" target="_blank" onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(document.URL) + '&t=' + encodeURIComponent(document.URL)); return false;"><img src="/images/flat_web_icon_set/color/Facebook.png"></a></li>
  <li><a href="https://twitter.com/intent/tweet?source=http%3A%2F%2Felendur.com&text=:%20http%3A%2F%2Felendur.com&via=a0viedo" target="_blank" title="Tweet" onclick="window.open('https://twitter.com/intent/tweet?text=' + encodeURIComponent(document.title) + '%20'  + encodeURIComponent(document.URL)); return false;"><img src="/images/flat_web_icon_set/color/Twitter.png"></a></li>
  <li><a href="https://plus.google.com/share?url=http%3A%2F%2Felendur.com" target="_blank" title="Share on Google+" onclick="window.open('https://plus.google.com/share?url=' + encodeURIComponent(document.URL)); return false;"><img src="/images/flat_web_icon_set/color/Google+.png"></a></li>
  <li><a href="http://www.reddit.com/submit?url=http%3A%2F%2Felendur.com&title=" target="_blank" title="Submit to Reddit" onclick="window.open('http://www.reddit.com/submit?url=' + encodeURIComponent(document.URL) + '&title=' +  encodeURIComponent(document.title)); return false;"><img src="/images/flat_web_icon_set/color/Reddit.png"></a></li>
  <li><a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Felendur.com&title=&summary=&source=http%3A%2F%2Felendur.com" target="_blank" title="Share on LinkedIn" onclick="window.open('http://www.linkedin.com/shareArticle?mini=true&url=' + encodeURIComponent(document.URL) + '&title=' +  encodeURIComponent(document.title)); return false;"><img src="/images/flat_web_icon_set/color/LinkedIn.png"></a></li>
</ul><div class="tags"><a href="/tags/stack-traces/">stack traces</a><a href="/tags/node-js/">node.js</a><a href="/tags/javascript/">javascript</a><a href="/tags/tracing/">tracing</a></div><div class="paginator"><a href="/2016/06/28/setting-up-hexo-en/" class="next"><span>Next</span><i class="fa fa-chevron-right"></i></a></div><section id="comments"><div id="disqus_thread"></div></section><script type="text/javascript">(function() {
var d = document, s = d.createElement('script');

s.src = '//a0viedo.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script></section><footer><div class="copyright"><p><span class="author">© 2016 Alejandro Oviedo</span></p><p class="theme">Created with <a href="https://hexo.io/">Hexo.io</a>. Theme by <a href="https://github.com/ahonn/hexo-theme-even"> Even</a>.</p></div><label id="back2top"><i class="fa fa-chevron-up"></i></label></footer></div></body><script src="/js/back2top.js"></script></html>