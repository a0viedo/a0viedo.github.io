<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="description"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Know Your Stack Traces</title><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/fonts/iconfont/iconfont.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,600|Roboto Mono"><!-- google analytics--><script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-36283546-3', 'auto');
ga('send', 'pageview');</script></head><body><div id="main"><header><a href="/." class="logo">Elendur</a><ul class="nav"><li class="nav-link"><a href="/" target="_self">Home</a></li><li class="nav-link"><a href="/archives/" target="_self">Archives</a></li><li class="nav-link"><a href="/tags/" target="_self">Tags</a></li><li class="nav-link"><a href="/about/" target="_self">About</a></li></ul></header><section id="container"><article class="post"><h1 class="post-title">Know Your Stack Traces</h1><span class="post-time">Oct 6, 2016</span><span style="float:right; font-style: italic">Read the post in: <a href="/2016/10/06/know-your-stack-traces-en" class="lang-link">english</a>,&nbsp;<a href="/2016/10/06/know-your-stack-traces-es" class="lang-link">spanish</a></span><div class="post-content"><p>Durante los últimos meses estuve trabajando en una aplicación con una arquitectura de microservicios. Tuve que debuggear mensajes de erroes cómo “Something went wront with your request” con stack traces escasos y no descriptivos.<br>En el proceso de buscar esos errores aprendí algunas cosas.</p>
<h2 id="Stack-esto-stack-aquello"><a href="#Stack-esto-stack-aquello" class="headerlink" title="Stack esto, stack aquello"></a>Stack esto, stack aquello</h2><p>El stack es la parte de la memoria que mantiene registro en todo momento de las funciones invocadas hasta un momento específico en tu programa. <strong>Pensá de un stack trace como un grupo de entradas con un orden de precedencia</strong>, generalmente de arriba a abajo de funciones más recientes a menos recientes respectivamente.</p>
<p>Hagamos unas llamadas a funciones anidadas con la ayuda de un poco de recursión y <code>eval</code>:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fn</span>(<span class="params">n</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(n === <span class="number">0</span>) <span class="keyword">return</span> <span class="built_in">Error</span>().stack;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">eval</span>(<span class="string">`(function fn<span class="subst">$&#123;n&#125;</span>()&#123; return fn(n-1)&#125;)()`</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(fn(<span class="number">10</span>));</span><br></pre></td></tr></table></figure></p>
<p>Al ejecutar el ejemplo anterior en Chrome (y Node.js o cualquier runtime basado en V8) te mostrará algo cómo lo siguiente:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Error</span><br><span class="line">    at Error (native)</span><br><span class="line">    at fn (&lt;anonymous&gt;:2:24)</span><br><span class="line">    at fn1 (eval at fn (unknown source), &lt;anonymous&gt;:1:25)</span><br><span class="line">    at eval (eval at fn (unknown source), &lt;anonymous&gt;:1:34)</span><br><span class="line">    at fn (&lt;anonymous&gt;:3:12)</span><br><span class="line">    at fn2 (eval at fn (unknown source), &lt;anonymous&gt;:1:25)</span><br><span class="line">    at eval (eval at fn (unknown source), &lt;anonymous&gt;:1:34)</span><br><span class="line">    at fn (&lt;anonymous&gt;:3:12)</span><br><span class="line">    at fn3 (eval at fn (unknown source), &lt;anonymous&gt;:1:25)</span><br><span class="line">    at eval (eval at fn (unknown source), &lt;anonymous&gt;:1:34)</span><br></pre></td></tr></table></figure></p>
<p>Está siendo cortado, Chrome por defecto limita a 10 stack traces. Para cambiar el límite en Chrome,<br>Node o Edge podés ejecutar <code>Error.stackTraceLimit = Infinity</code>.</p>
<p>En Firefox, el límite es de 128 (al menos una potencia de 2, verdad?) y <a href="https://dxr.mozilla.org/mozilla-central/rev/ea104eeb14cc54da9a06c3766da63f73117723a0/js/src/jsexn.cpp#238" target="_blank" rel="external">parece ser que está hardcodeado</a>. En Safari no está limitado en lo absoluto. </p>
<h2 id="Long-stack-traces"><a href="#Long-stack-traces" class="headerlink" title="Long stack traces"></a>Long stack traces</h2><p>Los <em>stack traces</em> asincrónicos, también llamados <em>long stack traces</em>, son algo con lo que vas a tener que tratar si escribís JavaScript. Primero, si no viste la charla de Philip Roberts <a href="https://www.youtube.com/watch?v=8aGhZQkoFbQ" target="_blank" rel="external">“What the Heck is the Event Loop anyway”</a> andá y mirala ahora, yo espero.</p>
<p>Hecho? Ok, continuemos.</p>
<p>Por la naturaleza de cómo las cosas aparecen en el <em>event loop</em>, cualquier operación asincrónica (timers o I/O) tendrán un stack trace <em>local</em>. Miremos <a href="https://nodejs.org/api/errors.html#errors_new_error_message" target="_blank" rel="external">la documentación de Node.js sobre errores</a>:</p>
<blockquote>
<p>Los stack traces extienden únicamente a bien (a) el principio de ejecución de código sincrónica, o (b) el número de frames presente en la propiedad Error.stackTraceLimit, cualquiera que sea más pequeño.</p>
</blockquote>
<p>Cuando se debuggea es común querer toda la granularidad que se pueda tener para ser capaz de identificar el path a la línea de código que tiene el error. Sin importar si pasó por operaciones asincrónicas para ser ejecutada.</p>
<p>Es cuando los long stack traces entran en juego: son una extensión de los stack traces en un intento de llevar registro del origen de las operaciones asincrónicas.</p>
<p><a href="https://www.npmjs.com/package/longjohn" target="_blank" rel="external">Longjohn</a> es un módulo muy útil de npm que llevará registro de todas las operaciones asincrónicas y te proveerá de stack traces completos (internamente reemplaza todas las operaciones asincrónicas con su propio wrapper para hacerlo).</p>
<p>Así es cómo podés obtener long stack traces con Longjohn y Bluebird (resulta ser la que yo uso, podría ser cualquier implementación de Promises):<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'longjohn'</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="built_in">Promise</span> = <span class="built_in">require</span>(<span class="string">'bluebird'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">example</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="built_in">Promise</span>.resolve().then(() =&gt; <span class="built_in">console</span>.log(<span class="built_in">Error</span>().stack));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">example();</span><br></pre></td></tr></table></figure></p>
<p>Tené en cuenta que usar long stack traces tendrá cierto hit en la performance.</p>
<p>Nota para usuarios de Bluebird: el <a href="http://bluebirdjs.com/docs/api/promise.longstacktraces.html" target="_blank" rel="external">feature de long stack traces</a> sólo funcionará cuando se haga <code>throw</code>. Ejemplo:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="built_in">Promise</span> = <span class="built_in">require</span>(<span class="string">'bluebird'</span>);</span><br><span class="line"><span class="built_in">Promise</span>.longStackTraces();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">example</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="built_in">Promise</span>.resolve().then(() =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">Error</span>().stack); <span class="comment">// no appereance of the function name</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">example();</span><br></pre></td></tr></table></figure>
<p>Lo cual no es bueno para las herramientas de tracing que usan el estado del stack pero no hacen throw.</p>
<h2 id="¿Que-es-lo-siguiente"><a href="#¿Que-es-lo-siguiente" class="headerlink" title="¿Qué es lo siguiente?"></a>¿Qué es lo siguiente?</h2><p>Es un problema no muy conocido el hecho de que no podamos tener promesas nativas (Node v4 o posterior) con stack traces asincrónicos funcionando. Si tenés un error de <code>unhandledRejection</code> en tu aplicación y estás usando promesas nativas, <strong>el único workaround para obtener un long stack trace es cambiar a otra implementación de promesas y usar un módulo cómo <a href="https://www.npmjs.com/package/longjohn" target="_blank" rel="external">longjohn</a></strong>.</p>
<p>Por el momento tampoco está claro cómo se va a resolver el problema de long stack traces con promesas nativas, ya sea para Node o en browsers. <a href="https://github.com/nodejs/node-eps/pull/18" target="_blank" rel="external">AsyncHooks</a> podría ser una solución factible para Node. Por el momento, sólo sé que voy a estar evitando usar promesas nativas por un tiempo.</p>
<p>¿Estás usando otras herramientas? ¿Te encontraste con otros problemas? Contamelo en los comentarios.</p>
</div></article><ul class="share-buttons">
  <li><a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Felendur.com&t=" title="Share on Facebook" target="_blank" onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(document.URL) + '&t=' + encodeURIComponent(document.URL)); return false;"><img src="/images/flat_web_icon_set/color/Facebook.png"></a></li>
  <li><a href="https://twitter.com/intent/tweet?source=http%3A%2F%2Felendur.com&text=:%20http%3A%2F%2Felendur.com&via=a0viedo" target="_blank" title="Tweet" onclick="window.open('https://twitter.com/intent/tweet?text=' + encodeURIComponent(document.title) + '%20'  + encodeURIComponent(document.URL)); return false;"><img src="/images/flat_web_icon_set/color/Twitter.png"></a></li>
  <li><a href="https://plus.google.com/share?url=http%3A%2F%2Felendur.com" target="_blank" title="Share on Google+" onclick="window.open('https://plus.google.com/share?url=' + encodeURIComponent(document.URL)); return false;"><img src="/images/flat_web_icon_set/color/Google+.png"></a></li>
  <li><a href="http://www.reddit.com/submit?url=http%3A%2F%2Felendur.com&title=" target="_blank" title="Submit to Reddit" onclick="window.open('http://www.reddit.com/submit?url=' + encodeURIComponent(document.URL) + '&title=' +  encodeURIComponent(document.title)); return false;"><img src="/images/flat_web_icon_set/color/Reddit.png"></a></li>
  <li><a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Felendur.com&title=&summary=&source=http%3A%2F%2Felendur.com" target="_blank" title="Share on LinkedIn" onclick="window.open('http://www.linkedin.com/shareArticle?mini=true&url=' + encodeURIComponent(document.URL) + '&title=' +  encodeURIComponent(document.title)); return false;"><img src="/images/flat_web_icon_set/color/LinkedIn.png"></a></li>
</ul><div class="tags"><a href="/tags/stack-traces/">stack traces</a><a href="/tags/node-js/">node.js</a><a href="/tags/javascript/">javascript</a><a href="/tags/tracing/">tracing</a></div><div class="paginator"><a href="/2017/01/31/configuring-a-local-docker-registry-en/" class="prev"><i class="fa fa-chevron-left"></i><span> Prev</span></a><a href="/2016/06/28/setting-up-hexo-en/" class="next"><span>Next</span><i class="fa fa-chevron-right"></i></a></div><section id="comments"><div id="disqus_thread"></div></section><script type="text/javascript">(function() {
var d = document, s = d.createElement('script');

s.src = '//a0viedo.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script></section><footer><div class="copyright"><p><span class="author">© 2016 Alejandro Oviedo</span></p><p class="theme">Created with <a href="https://hexo.io/">Hexo.io</a>. Theme by <a href="https://github.com/ahonn/hexo-theme-even"> Even</a>.</p></div><label id="back2top"><i class="fa fa-chevron-up"></i></label></footer></div></body><script src="/js/back2top.js"></script></html>