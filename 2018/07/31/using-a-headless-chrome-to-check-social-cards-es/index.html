<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="description"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Usando un Chrome headless para verificar social cards</title><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/fonts/iconfont/iconfont.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,600|Roboto Mono"><!-- google analytics--><script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-36283546-3', 'auto');
ga('send', 'pageview');</script></head><body><div id="main"><header><a href="/." class="logo">Elendur</a><ul class="nav"><li class="nav-link"><a href="/" target="_self">Home</a></li><li class="nav-link"><a href="/archives/" target="_self">Archives</a></li><li class="nav-link"><a href="/tags/" target="_self">Tags</a></li><li class="nav-link"><a href="/about/" target="_self">About</a></li></ul></header><section id="container"><article class="post"><h1 class="post-title">Usando un Chrome headless para verificar social cards</h1><span class="post-time">Jul 31, 2018</span><span style="float:right; font-style: italic">Read the post in: <a href="/2018/07/31/using-a-headless-chrome-to-check-social-cards-en" class="lang-link">english</a>,&nbsp;<a href="/2018/07/31/using-a-headless-chrome-to-check-social-cards-es" class="lang-link">spanish</a></span><div class="post-content"><p>Para esta época del año es cuando, desde NodeConf Argentina, empezamos a anunciar nuevos oradores y hay algunas verificaciones que usualmente hacemos en el sitio después de que los cambios en el HTML están hechos. Esas verificaciones son:</p>
<ul>
<li>que los cambios no rompan nada</li>
<li>la social card para Twitter se ve bien</li>
<li>la social card para Facebook se ve bien</li>
</ul>
<p>Estaba empezando a cansarme de realizar estos últimos dos chequeos manualmente y pensé “debería haber una forma de automatizarlos, no?”. Resulta que para Twitter encontré un <a href="https://cards-dev.twitter.com/validator" target="_blank" rel="external">Card Validator</a> y Facebook tiene un <a href="https://developers.facebook.com/tools/debug/" target="_blank" rel="external">URL Debugger</a>. Este artículo cuenta cómo utilicé <a href="https://github.com/GoogleChrome/puppeteer" target="_blank" rel="external">Puppeteer</a> para navegar el Card Validator de Twitter, realizar una captura de pantalla, subirla a Imgur y pegar su URL cómo comentario en un pull request.</p>
<h2 id="Primero-lo-primero"><a href="#Primero-lo-primero" class="headerlink" title="Primero lo primero"></a>Primero lo primero</h2><p>Ya tenía la configuración para que TravisCI ejecute un build por cada pull request funcionando. Si querés saber más detalles acerca de cómo lo configuré podés leer más en <a href="https://elendur.com/2018/05/15/run-lighthouse-for-every-pr-en/">Running Lighthouse for every PR with Travis CI</a>. Anteriormente estaba usando Surge.sh para los deploys, pero con los submodains de Surge.sh un archivo <code>robots.txt</code> se sobreescribe haciendo que sea imposible utilizarlo en el validador de Twitter.</p>
<p>Migré a <a href="https://zeit.co/now" target="_blank" rel="external">now</a> y utilizando deployments públicos resultó ser bastante directo.</p>
<h2 id="Entrando-al-mundo-Puppeteer"><a href="#Entrando-al-mundo-Puppeteer" class="headerlink" title="Entrando al mundo Puppeteer"></a>Entrando al mundo Puppeteer</h2><p>Tenía ya Lighthouse ejecutandose hacia el deploy de <code>now</code> por lo que habían tres cosas que faltaban:</p>
<ol>
<li>obtener la lista de archivos modificados</li>
<li>utilizar Puppeteer para hacer la captura de pantalla</li>
<li>subir la captura a Imgur</li>
</ol>
<p>Para el primero de estos pasos utilicé un comando git que, si no especifica el branch de origen, retornará la lista de archivos modificados comparando contra el branch actual (el del pull request). El comando es el siguiente:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git diff --name-status master</span><br></pre></td></tr></table></figure>
<p>Para que Puppeteer saque la captura de pantalla necesité impersonar mi sesión de Twitter, luego ingresar la URL que quería verificar y por último clickear en el botón “Preview Card”. Para lo primero utilicé <code>page.setCookie</code> con una variable de entorno configurada en Travis CI. Siguiente, emulé el viewport que me convenía, navegué al sitio del Card Validator</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> page.goto(<span class="string">'https://cards-dev.twitter.com/validator'</span>, &#123;</span><br><span class="line">    waitLoad: <span class="literal">true</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>y use el resultado del paso 1 con la URL de deploy (utilizado como argumento en la consola)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> page.click(textInputSelector);</span><br><span class="line"><span class="keyword">await</span> page.keyboard.type(process.argv[<span class="number">2</span>]);</span><br></pre></td></tr></table></figure>
<p>Para que la captura de pantalla se muestre correctamente tenía que esperar a que un iframe se inicialize en la página. Pero esto está lejos de ser perfecto ya que no pude encontrar una solución sin agregar una espera de un número arbitrario de milisegundos. Todo el arcihvo es menos de 70 líneas de código, podés encontrarlo <a href="https://github.com/nodeconfar/2018-website/blob/4e05c4d28d28a4c26a3498ff28064677e481b5ec/tools/screenshot.js" target="_blank" rel="external">acá</a>.</p>
<p>Para completar el paso n°3 usé <a href="https://imgur.com/" target="_blank" rel="external">Imgur</a> y un <a href="https://github.com/tremby/imgur.sh" target="_blank" rel="external">script</a> de bash muy útil. Podés especificar tu client ID agregando la variable de entorno IMGUR_CLIENT_ID a tu build.</p>
<p align="center"><a href="https://i.imgur.com/wssX9JZ.png" target="_blank" rel="external"><figure><img src="https://i.imgur.com/4Wq6WiP.png" width="600"><figcaption style="text-align: center">How the end result looks like on a pull request.</figcaption></figure></a></p>

<h2 id="Conclusiones"><a href="#Conclusiones" class="headerlink" title="Conclusiones"></a>Conclusiones</h2><p>Podría ser muy útil también agregar la verificación de la social card para Facebook también, pero la plataforma sube imágenes de forma asincrónica por lo que la lógica para Puppeteer sería bastante tediosa.<br>A esta altura voy a decir que Puppeteer es una herramienta bastante poderosa pero también pienso que hay algunas mejoras posibles por ejemplo en la API para eventos asincrónicos. Incluso después de esperar para diferentes eventos disparados en un iframe insertado dinámicamente tuve que agregar un timer para esperar a que los cambios sean rendereados.<br>Por cierto, no deberías impersonar tu sesión de Twitter para nada serio. Para esos casos creá una cuenta específica para tu automatización.</p>
<p>¿Usaste Puppeteer en alguna parte de tu flujo de CI? ¡Contame en los comentarios!</p>
</div></article><ul class="share-buttons">
  <li><a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Felendur.com&t=" title="Share on Facebook" target="_blank" onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(document.URL) + '&t=' + encodeURIComponent(document.URL)); return false;"><img src="/images/flat_web_icon_set/color/Facebook.png"></a></li>
  <li><a href="https://twitter.com/intent/tweet?source=http%3A%2F%2Felendur.com&text=:%20http%3A%2F%2Felendur.com&via=a0viedo" target="_blank" title="Tweet" onclick="window.open('https://twitter.com/intent/tweet?text=' + encodeURIComponent(document.title) + '%20'  + encodeURIComponent(document.URL)); return false;"><img src="/images/flat_web_icon_set/color/Twitter.png"></a></li>
  <li><a href="https://plus.google.com/share?url=http%3A%2F%2Felendur.com" target="_blank" title="Share on Google+" onclick="window.open('https://plus.google.com/share?url=' + encodeURIComponent(document.URL)); return false;"><img src="/images/flat_web_icon_set/color/Google+.png"></a></li>
  <li><a href="http://www.reddit.com/submit?url=http%3A%2F%2Felendur.com&title=" target="_blank" title="Submit to Reddit" onclick="window.open('http://www.reddit.com/submit?url=' + encodeURIComponent(document.URL) + '&title=' +  encodeURIComponent(document.title)); return false;"><img src="/images/flat_web_icon_set/color/Reddit.png"></a></li>
  <li><a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Felendur.com&title=&summary=&source=http%3A%2F%2Felendur.com" target="_blank" title="Share on LinkedIn" onclick="window.open('http://www.linkedin.com/shareArticle?mini=true&url=' + encodeURIComponent(document.URL) + '&title=' +  encodeURIComponent(document.title)); return false;"><img src="/images/flat_web_icon_set/color/LinkedIn.png"></a></li>
</ul><div class="tags"><a href="/tags/javascript/">javascript</a><a href="/tags/ci/">ci</a><a href="/tags/automation/">automation</a><a href="/tags/puppeteer/">puppeteer</a><a href="/tags/chrome/">chrome</a><a href="/tags/headless/">headless</a></div><div class="paginator"><a href="/2018/05/15/run-lighthouse-for-every-pr-en/" class="next"><span>Next</span><i class="fa fa-chevron-right"></i></a></div><section id="comments"><div id="disqus_thread"></div></section><script type="text/javascript">(function() {
var d = document, s = d.createElement('script');

s.src = '//a0viedo.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script></section><footer><div class="copyright"><p><span class="author">© 2016 Alejandro Oviedo</span></p><p class="theme">Created with <a href="https://hexo.io/">Hexo.io</a>. Theme by <a href="https://github.com/ahonn/hexo-theme-even"> Even</a>.</p></div><label id="back2top"><i class="fa fa-chevron-up"></i></label></footer></div></body><script src="/js/back2top.js"></script></html>