<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="description"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Docker Swarm Architecture</title><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/fonts/iconfont/iconfont.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,600|Roboto Mono"><!-- google analytics--><script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-36283546-3', 'auto');
ga('send', 'pageview');</script></head><body><div id="main"><header><a href="/." class="logo">Elendur</a><ul class="nav"><li class="nav-link"><a href="/" target="_self">Home</a></li><li class="nav-link"><a href="/archives/" target="_self">Archives</a></li><li class="nav-link"><a href="/tags/" target="_self">Tags</a></li><li class="nav-link"><a href="/about/" target="_self">About</a></li></ul></header><section id="container"><article class="post"><h1 class="post-title">Docker Swarm Architecture</h1><span class="post-time">Feb 14, 2017</span><span style="float:right; font-style: italic">Read the post in: <a href="/2017/02/14/docker-swarm-architecture-en" class="lang-link">english</a>,&nbsp;<a href="/2017/02/14/docker-swarm-architecture-es" class="lang-link">spanish</a></span><div class="post-content"><p>I’m working on a Docker Swarm deployment to production and these are some of my thoughts on how things should be. In my case the deployment is on AWS but I’m deliberately skipping the AWS-specific parts on this blog post.</p>
<h2 id="Know-the-Basics"><a href="#Know-the-Basics" class="headerlink" title="Know the Basics"></a>Know the Basics</h2><p>A swarm will consist of <strong><em>managers</em></strong>, <strong><em>nodes</em></strong> and <strong><em>services</em></strong>.<br> A <strong>node</strong> is basically a worker of your swarm, it will only receive instructions. <br> A <strong>manager</strong> is a node that can give instructions to your swarm (i.e. creating and removing services). Managers can also run instances of services.</p>
<p>A <strong>service</strong> can have multiple replicas and Docker will distribute them evenly across your nodes - if you have 3 (active) nodes and a service with 3 replicas, each node will have a running instance of that service.</p>
<p>For any service in the swarm, Docker will do a round-robin between the replicas (shameless plug, watch <a href="https://www.youtube.com/watch?v=kpvbOzHUakA" target="_blank" rel="external">Load balancing is impossible</a>). Docker call this feature of distributing incoming connections from outside the swarm <em>ingress load balancing</em>. Is important to say that if you access a service from within the swarm it will also go through the built-in load balancer.</p>
<p>If you try to access a service on a node that’s not running it Docker will re-reoute the request to a node that has a running instance of that service.</p>
<p align="center"><a href="https://i.imgur.com/wssX9JZ.png" target="_blank" rel="external"><img src="https://i.imgur.com/wssX9JZ.png" width="600"></a></p>

<p>Here the component labeled LB is serving as a reverse proxy and it will have to be able to discover new nodes in your swarm dynamically.</p>
<h2 id="Networks"><a href="#Networks" class="headerlink" title="Networks"></a>Networks</h2><p>For my very basic setup I created an encrypted overlay network for - initially - all my services.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create --driver overlay --subnet 10.0.9.0/24 --opt encrypted my-network</span><br></pre></td></tr></table></figure></p>
<p>Of course you can create specific networks for groups of services but that will depend on your requirements and use cases.</p>
<h2 id="Communication-between-services"><a href="#Communication-between-services" class="headerlink" title="Communication between services"></a>Communication between services</h2><p>By default Docker Swarm configures DNS service discovery for you so you will be able to access from a service to another service in your swarm via its name, if they share the same network.</p>
<h2 id="Registry"><a href="#Registry" class="headerlink" title="Registry"></a>Registry</h2><p>In my case, I configured a private - HTTP only - registry to serve my Docker images (see <a href="https://elendur.com/2017/01/31/configuring-a-local-docker-registry-en/">Configuring a local Docker Registry</a>). Since it wont be public and I only need it available in the virtual network of my instances I don’t see any reason why I should configure TLS on it.</p>
<h2 id="Autoscalling-groups"><a href="#Autoscalling-groups" class="headerlink" title="Autoscalling groups"></a>Autoscalling groups</h2><p>It’s very important to have redundancy of managers in your swarm because <strong>if you have only one manager and something goes wrong, you will lose the entire swarm</strong>. That being said, it’s also important to have an odd number of managers due to the nature of the algorithm that Swarm uses to choose their leader (read more in <a href="https://docs.docker.com/engine/swarm/admin_guide/#/distribute-manager-nodes" target="_blank" rel="external">this section</a>). You should also consistently <a href="https://docs.docker.com/engine/swarm/admin_guide/#/back-up-the-swarm-state" target="_blank" rel="external">backup the swarm state</a>.</p>
<p>Ideally you will count with two autoscalling groups, one for your managers and another one for your nodes.</p>
<p>For small clusters I see no problem on letting the managers run service’s instances but in big clusters you should have only dedicated managers - see how to do it <a href="https://docs.docker.com/engine/swarm/admin_guide/#/run-manager-only-nodes" target="_blank" rel="external">here</a>.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>This blog post focus on architecture decisions but definitely the development and deployment pipelines are two other important parts that are missing. I may write something once I’m more familiar with them.</p>
<p>If you have configured your swarm in a different way or I’m missing some neat features tell me in the comments!</p>
<h2 id="Other-resources"><a href="#Other-resources" class="headerlink" title="Other resources"></a>Other resources</h2><ul>
<li><a href="https://docs.docker.com/engine/swarm/" target="_blank" rel="external">Docker Swarm features</a></li>
<li><a href="http://docs-stage.docker.com/v1.10/swarm/swarm_at_scale/01-about/" target="_blank" rel="external">Learn application architecture</a></li>
<li><a href="http://blog.scottlogic.com/2016/08/30/docker-1-12-swarm-mode-round-robin.html" target="_blank" rel="external">Docker 1.12 Swarm Mode - Round Robin inside and out</a></li>
<li><a href="https://docs.docker.com/engine/swarm/raft/" target="_blank" rel="external">Raft consensus in swarm mode</a></li>
</ul>
<hr>
<p>Thanks to <a href="https://twitter.com/mvaldesdeleon" target="_blank" rel="external">Martin</a> and <a href="https://twitter.com/gonrial" target="_blank" rel="external">Ezequiel</a> for reviewing this post and helping me to tune up the diagram.</p>
</div></article><ul class="share-buttons">
  <li><a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Felendur.com&t=" title="Share on Facebook" target="_blank" onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(document.URL) + '&t=' + encodeURIComponent(document.URL)); return false;"><img src="/images/flat_web_icon_set/color/Facebook.png"></a></li>
  <li><a href="https://twitter.com/intent/tweet?source=http%3A%2F%2Felendur.com&text=:%20http%3A%2F%2Felendur.com&via=a0viedo" target="_blank" title="Tweet" onclick="window.open('https://twitter.com/intent/tweet?text=' + encodeURIComponent(document.title) + '%20'  + encodeURIComponent(document.URL)); return false;"><img src="/images/flat_web_icon_set/color/Twitter.png"></a></li>
  <li><a href="https://plus.google.com/share?url=http%3A%2F%2Felendur.com" target="_blank" title="Share on Google+" onclick="window.open('https://plus.google.com/share?url=' + encodeURIComponent(document.URL)); return false;"><img src="/images/flat_web_icon_set/color/Google+.png"></a></li>
  <li><a href="http://www.reddit.com/submit?url=http%3A%2F%2Felendur.com&title=" target="_blank" title="Submit to Reddit" onclick="window.open('http://www.reddit.com/submit?url=' + encodeURIComponent(document.URL) + '&title=' +  encodeURIComponent(document.title)); return false;"><img src="/images/flat_web_icon_set/color/Reddit.png"></a></li>
  <li><a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Felendur.com&title=&summary=&source=http%3A%2F%2Felendur.com" target="_blank" title="Share on LinkedIn" onclick="window.open('http://www.linkedin.com/shareArticle?mini=true&url=' + encodeURIComponent(document.URL) + '&title=' +  encodeURIComponent(document.title)); return false;"><img src="/images/flat_web_icon_set/color/LinkedIn.png"></a></li>
</ul><div class="tags"><a href="/tags/docker/">docker</a><a href="/tags/architecture/">architecture</a><a href="/tags/docker-swarm/">docker-swarm</a><a href="/tags/containers/">containers</a></div><div class="paginator"><a href="/2018/05/13/node-clinic-en/" class="prev"><i class="fa fa-chevron-left"></i><span> Prev</span></a><a href="/2017/01/31/configuring-a-local-docker-registry-en/" class="next"><span>Next</span><i class="fa fa-chevron-right"></i></a></div><section id="comments"><div id="disqus_thread"></div></section><script type="text/javascript">(function() {
var d = document, s = d.createElement('script');

s.src = '//a0viedo.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script></section><footer><div class="copyright"><p><span class="author">© 2016 Alejandro Oviedo</span></p><p class="theme">Created with <a href="https://hexo.io/">Hexo.io</a>. Theme by <a href="https://github.com/ahonn/hexo-theme-even"> Even</a>.</p></div><label id="back2top"><i class="fa fa-chevron-up"></i></label></footer></div></body><script src="/js/back2top.js"></script></html>